<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sports World Billing</title>

<style>
body { font-family: Arial; padding: 10px; background:#f2f2f2 }
input, button { width:100%; padding:12px; margin:6px 0; font-size:18px }
button { background:#2563eb; color:white; border:none }
.card { background:#fff; padding:8px; margin:5px 0; border-radius:5px }
</style>
</head>
<body>

<h2>Sports World</h2>

<input id="price" type="number" placeholder="Enter price">
<button onclick="addItem()">Add Item</button>

<div id="items"></div>

<h3>Total: ₹ <span id="total">0</span></h3>

<button onclick="printBill()">Print Bill</button>

<script>
let items = [];
let printerChar = null;

// ADD ITEM
function addItem() {
    const val = Number(document.getElementById("price").value);
    if (!val) return alert("Enter amount");

    items.push(val);
    document.getElementById("price").value = "";
    render();
}

// SHOW ITEMS
function render() {
    let html = "";
    let total = 0;

    items.forEach(p => {
        total += p;
        html += `<div class="card">₹ ${p}</div>`;
    });

    document.getElementById("items").innerHTML = html;
    document.getElementById("total").innerText = total;
}

// CONNECT BLUETOOTH
async function connectPrinter() {
    const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [0xFFE0]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(0xFFE0);
    printerChar = await service.getCharacteristic(0xFFE1);
}

// PRINT BILL
async function printBill() {
    if (items.length === 0) {
        alert("Add items first");
        return;
    }

    if (!printerChar) {
        await connectPrinter();
    }

    let total = items.reduce((a,b)=>a+b,0);

    let bill = "";
    bill += "--------------------------\n";
    bill += "        BILL\n";
    bill += "--------------------------\n\n";

    items.forEach(price => {
        bill += "                ₹" + price + "\n";
    });

    bill += "\n--------------------------\n";
    bill += "TOTAL:          ₹" + total + "\n";
    bill += "--------------------------\n";
    bill += "  Thank You!\n\n";

    const encoder = new TextEncoder();
    const data = encoder.encode(bill);

    try {
        await printerChar.writeValue(new Uint8Array([0x1B, 0x40]));

        for (let i = 0; i < data.length; i += 40) {
            await printerChar.writeValue(data.slice(i, i + 40));
            await new Promise(r => setTimeout(r, 40));
        }

        alert("Printed Successfully!");

        saveBill();
        items = [];
        render();

    } catch (err) {
        alert("Print failed");
        console.error(err);
    }
}

// SAVE TO BACKEND
async function saveBill() {
    await fetch("https://sportsworld-backend.onrender.com/bills", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            date: new Date(),
            items: items,
            total: items.reduce((a,b)=>a+b,0)
        })
    });
}
</script>

</body>
</html>
